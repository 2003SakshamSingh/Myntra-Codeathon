<!-- @format -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Myntra - Community Forum</title>
    <link rel="icon" href="../IMAGES/Logo/myntra.svg" />
    <script
      src="https://kit.fontawesome.com/a076d05399.js"
      crossorigin="anonymous"
    ></script>

    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    />
    <link rel="stylesheet" href="../Style/navbar.css" />
    <link rel="stylesheet" href="../Style/footer.css" />
    <link rel="stylesheet" href="../Style/Home&Living.css" />
    <link rel="stylesheet" href="../Style/communityForum.css" />
  </head>
  <body>
    <!-- Nav-Bar -->
    <header id="headportion"></header>
    <div class="nav-padding"></div>

    <div class="title">
      <h2>Welcome to Myntra's very own Community Forum !</h2>
      <br />
      <p>
        Chat with different communities and groups <br />
        Take suggestions, ask for reviews and much more ...
      </p>
    </div>

    <br />

    <!-- section buttons -->
    <div class="container">
      <div class="left">
        <div class="switch" style="overflow-x: auto; overflow-y: hidden">
          <div
            class="comm addCommunity open-button"
            onclick="openForm()"
            id="addCommunity"
          >
            <i class="fas fa-plus fa-2xl"></i>
          </div>
          <div class="form-popup" id="myForm">
            <form id="communityForm" class="form-container">
              <h1>Create your Community</h1> <hr>
              <label for="community"><b>Community Name</b></label>
              <input
                id="communityNameInput"
                type="text"
                placeholder="Enter Community Name"
                name="community"
                required
              />

              <button type="submit" class="btn">Create</button>
              <button type="button" class="btn cancel" onclick="closeForm()">
                Close
              </button>
            </form>
          </div>
          <!-- <div class="comm" id="comm1">
            <h2>Marwadi</h2>
          </div>
          <div class="comm" id="comm2">
            <h2>Shadi</h2>
          </div>
          <div class="comm" id="comm3">
            <h2>Bihar</h2>
          </div>
          <div class="comm" id="comm4">
            <h2>Influencer</h2>
          </div>
          <div class="comm" id="comm5">
            <h2>Family</h2>
          </div> -->
        </div>

        <div class="community-chat" style="overflow: hidden">
          <h2>Community Chat</h2>
          <br>
          <h4 class="community-name" id="community-name">community-name</h4>
          <div class="communityPostsContainer"></div>
          <form class="addCommunityPosts">
            <input type="file" id="file-input-1" name="file-input-1" />
            <label id="file-input-label-1" for="file-input-1">+</label>
            <input
            type="text"
            class="input-message"
            id="communityPostContent"
            placeholder="Type your message..."
            />
            <button class="send-btn addPostBtn">
              <img
                src="../IMAGES/Chat-Forum/send_icon.svg"
                alt=""
              />
            </button>
          </form>
        </div>
      </div>

      <div class="right" style="overflow: hidden">
        <div class="global-chat">
          <div>
            <h2>Global Chat</h2>
          </div>

          <div class="popularPostsContainer"></div>
          <form class="bottomDiv">
            <input
              type="text"
              class="input-message"
              id="postContent"
              placeholder="Type your message..."
            />
            <!-- <input type="file" class="input-file" id="global-file-input" /> -->
            <button class="send-btn addPostBtn"></button>
          </form>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer id="footerEl"></footer>

    <script src="../JS/Home&living.js" type="module"></script>

    <script type="text/javascript">
      function googleTranslateElementInit() {
        new google.translate.TranslateElement(
          {
            pageLanguage: "en,",
            includedLanguages: "hi,en,bn,gu,kn,ml,mr,ta,te,ur,",
          },
          "google_translate_element"
        );
      }
    </script>

    <script
      src="https://kit.fontawesome.com/e01365bc7d.js"
      crossorigin="anonymous"
    ></script>

    <script
      type="text/javascript"
      src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"
    ></script>

    <script type="text/javascript" src="../JS/communityForum.js"></script>
    <script>
      function openForm() {
        document.getElementById("myForm").style.display = "block";
      }

      function closeForm() {
        document.getElementById("myForm").style.display = "none";
      }
    </script>
    <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-auth.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-firestore.js"></script>
    <!-- <script src="../JS/firebase.js"></script> -->
    <script type="module">
      const firebaseConfig = {
        apiKey: "AIzaSyD09nDzD73ieZzOvpLTj2H5nL9Ncrn9bVg",
        authDomain: "myntra-codeathon.firebaseapp.com",
        projectId: "myntra-codeathon",
        storageBucket: "myntra-codeathon.appspot.com",
        messagingSenderId: "796268558165",
        appId: "1:796268558165:web:4dcc91ef4727dbeec0e1dc",
        measurementId: "G-3N3QT2B8GB",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      //     async function getUserDetails(uid) {
      //     await db
      //       .collection("users")
      //       .doc(uid)
      //       .get()
      //       .then((doc) => {
      //         let data = doc.data();
      //         return data;
      //     })
      //     .catch ((error) => {
      //       console.error("Error in getUserDetails:", error);
      //     });
      // }
      let postForm = document.querySelector(".bottomDiv");
      let addPostBtn = document.querySelector(".addPostBtn");
      let communityForm = document.getElementById("communityForm");

      postForm.addEventListener("submit", (e) => {
        e.preventDefault();
        let postContent = document.getElementById("postContent").value;
        console.log(postContent);
        postContent = String(postContent);
        firebase.auth().onAuthStateChanged(async (user) => {
          if (user) {
            let userId = user.uid;
            await createPopularPost("Fashion Freaks", postContent, userId);
            location.reload();
          } else {
            location.replace("Login.html");
          }
        });
      });

      communityForm.addEventListener("submit", (e) => {
        e.preventDefault();
        let communityNameInput =
          document.getElementById("communityNameInput").value;
        communityNameInput = String(communityNameInput);
        firebase.auth().onAuthStateChanged(async (user) => {
          if (user) {
            let userId = user.uid;
            await createGroup(userId, communityNameInput);
            location.reload();
          } else {
            location.replace("Login.html");
          }
        });
      });

      async function displayCommunityPosts() {}

      // addPostBtn.onClick = function () {
      //     firebase.auth().onAuthStateChanged(async (user) => {
      //       if (user) {
      //         let userId = user.uid;
      //         await createPopularPost("Fashion Freaks", postContent.value, userId);
      //         big();
      //       }
      //       else {
      //               location.replace("Login.html");
      //             }
      //     });

      //   }

      async function getUserDetails(uid) {
        try {
          const doc = await db.collection("users").doc(uid).get();
          const data = doc.data();
          return data;
        } catch (error) {
          // Handle any errors here, e.g., log the error or return a default value
          console.error("Error in getUserDetails:", error);
          return null; // You can return an appropriate value in case of an error
        }
      }

      async function createGroup(uid, name) {
        await db
          .collection("groups")
          .where("name", "==", name)
          .get()
          .then(async (querySnapshot) => {
            if (querySnapshot.size > 0) {
              return "failure";
            } else {
              await db
                .collection("groups")
                .add({
                  name: name,
                  admin_uid: uid,
                  time: firebase.firestore.FieldValue.serverTimestamp(),
                })
                .then(() => {
                  return "success";
                });
            }
          });
      }

      async function createPopularPost(community_name, content, uid) {
        let userDetails = await getUserDetails(uid);
        let userName = userDetails.name;
        await db
          .collection("popular_posts")
          .add({
            community_name: community_name,
            sender_name: userName,
            time: firebase.firestore.FieldValue.serverTimestamp(),
            content: content,
            upvotes: 0,
            downvotes: 0,
            uid: uid,
            comments: [],
          })
          .then((docRef) => {
            console.log("Document written with ID: ", docRef.id);
          })
          .catch((error) => {
            console.error("Error adding document: ", error);
          });
      }

      async function getGroups() {
        let response = [];
        const collectionRef = db.collection("groups");
        await collectionRef
          .get()
          .then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
              let docId = doc.id;
              let docData = doc.data();
              let docResponse = {
                name: docData.name,
                admin_uid: docData.admin_uid,
                time: docData.time,
                doc_id: docId,
              };
              response.push(docResponse);
            });
          })
          .catch((error) => {
            console.error(error);
          });
        return response;
      }

      async function getGroupPosts(docId) {
        let response = [];
        const collectionRef = db
          .collection("groups")
          .doc(docId)
          .collection("posts");
        await collectionRef
          .get()
          .then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
              let docId = doc.id;
              let docData = doc.data();
              let docResponse = {
                community_name: docData.community_name,
                sender_name: docData.sender_name,
                time: docData.time,
                content: docData.content,
                upvotes: docData.upvotes,
                downvotes: docData.downvotes,
                doc_id: docId,
                uid: uid,
                comments: docData.comments,
              };
              response.push(docResponse);
            });
          })
          .catch((error) => {
            console.error(error);
          });
        return response;
      }

      async function getPopularPosts() {
        let response = [];
        const collectionRef = db.collection("popular_posts");
        await collectionRef
          .get()
          .then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
              let docId = doc.id;
              let docData = doc.data();
              let docResponse = {
                community_name: docData.community_name,
                sender_name: docData.sender_name,
                time: docData.time,
                content: docData.content,
                upvotes: docData.upvotes,
                downvotes: docData.downvotes,
                doc_id: docId,
                uid: docData.uid,
                comments: docData.comments,
              };
              response.push(docResponse);
            });
          })
          .catch((error) => {
            console.error(error);
          });
        return response;
      }

      //   async function addCommentsToPost(docId, uid, content) {

      //   let userDetails = await getUserDetails(uid);

      //   let userName = userDetails.name;
      //   // console.log(userName);
      //   await db
      //     .collection("popular_posts")
      //     .doc(docId)
      //     .update({
      //       comments: firebase.firestore.FieldValue.arrayUnion({
      //         uid: uid,
      //         name: userName,
      //         content: content,
      //         time: firebase.firestore.FieldValue.serverTimestamp(),
      //       }),
      //     })
      //     .catch((err) => {
      //       console.error(err);
      //     });
      // }

      async function addCommentsToPost(docId, uid, content) {
        try {
          // Get user details based on UID
          const userDetails = await getUserDetails(uid);
          const userName = userDetails.name;
          console.log(docId);
          // console.log(userName);
          // Create a new comment object
          const newComment = {
            uid: uid,
            name: userName,
            content: content,
            time: firebase.firestore.FieldValue.serverTimestamp(),
          };

          // Update the "comments" array in the specified document
          await db
            .collection("popular_posts")
            .doc(docId)
            .update({
              comments: firebase.firestore.FieldValue.arrayUnion(newComment),
            });

          console.log("Comment added successfully");
        } catch (error) {
          console.error("Error adding comment:", error);
        }
      }

      async function upvotePost(docId, upvotes) {
        await this.db.collection("popular_posts").doc(docId).update({
          upvotes: ++upvotes,
        });
      }

      async function downvotePost(docId, downvotes) {
        await this.db.collection("popular_posts").doc(docId).update({
          downvotes: ++downvotes,
        });
      }

      getGroups()
        .then((result) => {
          console.log(result);
          let communityContainer = document.querySelector(".switch");
          let count = 1;
          for (let c of result) {
            let community = document.createElement("div");
            community.innerHTML = `<h3>${c.name}</h3>`;
            community.className = "comm commNames";
            community.id = "comm" + count;
            communityContainer.appendChild(community);
            // console.log(community.id);
            count++;
          }
        })
        .catch((err) => {
          console.log(err);
        });

      getPopularPosts()
        .then((result) => {
          console.log(result);
          let popularPostsContainer = document.querySelector(
            ".popularPostsContainer"
          );
          for (let p of result) {
            let post = document.createElement("div");
            post.innerHTML = `<div class="userInfo">
    <h5><a href="#">${p.sender_name}</a><span class="communityName">${p.community_name}</span></h5>
  </div>
  
  
  
  
  <div class="postContent">
    ${p.content}
  </div>
  
  <hr><span class="votes"><a href="#" class="upVote">Upvote ${p.upvotes}</a></span><span class="votes"><a href="#" class="downVote">Downvote ${p.downvotes}</a></span>
  `;
            post.className = "popularPost";
            popularPostsContainer.appendChild(post);
            let addCommentForm = document.createElement("form");
            addCommentForm.innerHTML = `<input class="addCommentContent" placeholder="Type your comment..."/>
<button class="addCommentBtn">Add Comment</button>`;
            addCommentForm.className = "addCommentForm";
            popularPostsContainer.appendChild(addCommentForm);
            addCommentForm.addEventListener("submit", (e) => {
              e.preventDefault();
              const commentContent =
                document.querySelector(".addCommentContent").value;
              // var user = firebase.auth().currentUser;
              firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                  var uid = user.uid;
                  // console.log(uid);
                  // console.log(user.name);
                  var docId = p.doc_id;
                  // console.log(docId);
                  addCommentsToPost(docId, user.uid, commentContent);
                  location.replace("communityForum.html");
                } else {
                  location.replace("Login.html");
                }
              });
            });
            let commentsNumber = document.createElement("h5");
            if (p.comments.length === 0) {
              commentsNumber.innerText = "No comments yet";
            } else {
              if (p.comments.length === 1) {
                commentsNumber.innerText = p.comments.length + " comment :";
              } else {
                commentsNumber.innerText = p.comments.length + " comments :";
              }
            }
            commentsNumber.className = "commentsNumber";
            popularPostsContainer.appendChild(commentsNumber);
            for (let c of p.comments) {
              let comment = document.createElement("div");
              comment.innerHTML = `<div class="userInfo">
            <h5><a href="#">${c.name}</a></h5>
            </div>
            <div class="commentContent">
              ${c.content}
            </div>`;
              comment.className = "comment";
              popularPostsContainer.appendChild(comment);
            }
          }
        })
        .catch((err) => {
          console.log(err);
        });
      //       getPopularPosts()
      //       .then((result)=>{
      //         console.log(result)
      //         let popularPostsContainer = document.querySelector(".popularPostsContainer");
      //         for (let p of result)
      //         {
      //           let post = document.createElement("div");
      //           post.innerHTML = `<div class="userInfo">
      //     <h5><a href="#">${p.sender_name}</a><span class="communityName">${p.community_name}</span></h5>
      //   </div>

      //   <div class="postContent">
      //     ${p.content}
      //   </div>

      //   <hr><span class="votes"><a href="#" class="upVote">Upvote ${p.upvotes}</a></span><span class="votes"><a href="#" class="downVote">Downvote ${p.downvotes}</a></span>
      //   `;
      //           post.className = 'popularPost';
      //           popularPostsContainer.appendChild(post);
      //           let addCommentForm = document.createElement("form");
      //           addCommentForm.innerHTML = `<input class="addCommentContent" placeholder="Type your comment..."/>
      // <button class="addCommentBtn">Add Comment</button>`;
      //           addCommentForm.className = "addCommentForm";
      //           popularPostsContainer.appendChild(addCommentForm);
      //           addCommentForm.addEventListener('submit', e => {
      //             e.preventDefault();
      //             const commentContent = document.querySelector(".addCommentContent").value;
      //             // var user = firebase.auth().currentUser;
      //             firebase.auth().onAuthStateChanged((user) => {
      //               if (user) {
      //                 var uid = user.uid;
      //                 // console.log(uid);
      //                 // console.log(user.name);
      //                 var docId = p.doc_id;
      //                 // console.log(docId);
      //                 addCommentsToPost(docId, user.uid, commentContent);
      //                 location.replace("communityForum.html");
      //               }
      //               else {
      //                 location.replace("Login.html");
      //               }
      //             })
      //           })
      //           let commentsNumber = document.createElement("h5");
      //           if (p.comments.length === 0)
      //           {
      //             commentsNumber.innerText = "No comments yet";
      //           }
      //           else
      //           {
      //             if (p.comments.length === 1)
      //             {
      //               commentsNumber.innerText = p.comments.length + " comment :";
      //             }
      //             else
      //             {
      //               commentsNumber.innerText = p.comments.length + " comments :";
      //             }

      //           }
      //           commentsNumber.className = "commentsNumber";
      //           popularPostsContainer.appendChild(commentsNumber);
      //           for (let c of p.comments)
      //           {
      //             let comment = document.createElement("div");
      //             comment.innerHTML = `<div class="userInfo">
      //             <h5><a href="#">${c.name}</a></h5>
      //             </div>
      //             <div class="commentContent">
      //               ${c.content}
      //             </div>`;
      //             comment.className = "comment";
      //             popularPostsContainer.appendChild(comment);
      //           }
      //         }

      //       })
      //       .catch(err=>{
      //         console.log(err)
      //       });
    </script>
  </body>
</html>

<div>
  <div class="userInfo">
    <h5>
      <a href="#">${p.sender_name}</a
      ><span class="communityName">${p.community_name}</span>
    </h5>
  </div>
  <hr />
  <div class="postContent">${p.content}</div>
  <hr />
</div>

<!-- <span class="addComment"><button class="addCommentBtn">Add comment</button></span> -->

<!-- <span class="voteIcons icon1"><i class="far fa-thumbs-up"></i></span><span class="voteIcons icon2"><i class="far fa-thumbs-down"></i></span> -->

<input class="addCommentContent" placeholder="Type your comment..." />
<button class="addCommentBtn">Add Comment</button>
